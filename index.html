<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus OS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap/dist/css/jsvectormap.min.css" />

    <style>
        :root {
            /* CLEAN LIGHT THEME */
            --bg-body: #f0f2f5;       /* Light Grey Background */
            --bg-card: #ffffff;       /* White Cards */
            --text-main: #1c1e21;     /* Dark Text */
            --text-muted: #65676b;    /* Grey Text */
            --border: #e4e6eb;        /* Subtle Border */
            
            --primary: #0d6efd;       /* Bootstrap Blue */
            --success: #198754;       /* Green */
            
            --map-base: #e4e6eb;      /* Light Map Background */
            --map-hover: #d8dadf;
            --map-visited: #0d6efd;   /* Visited Country Color */

            --nav-height: 65px;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: var(--nav-height);
        }

        h2, h5 { font-weight: 700; color: var(--text-main); }
        h2 { font-size: 1.5rem; }

        /* CARDS */
        .nexus-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Soft Shadow */
        }

        /* INPUTS */
        .form-control, .form-select {
            background-color: #f0f2f5;
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 8px;
        }
        .form-control:focus {
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
        }

        /* MAP */
        #world-map {
            width: 100%;
            height: 320px;
            background-color: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* STATS */
        .stat-number { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* FILTERS */
        .filter-btn {
            background: #fff;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 6px;
            font-weight: 500;
        }
        .filter-btn.active {
            background-color: var(--primary);
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }

        /* HISTORY LIST */
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .history-item:last-child { border-bottom: none; }
        .item-title { font-weight: 600; font-size: 0.95rem; }
        .item-meta { font-size: 0.8rem; color: var(--text-muted); }

        /* TYPE BADGES */
        .badge-type { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
        .bg-book { background-color: #e7f5ff; color: #007bff; }
        .bg-movie { background-color: #fff5f5; color: #dc3545; }
        .bg-music { background-color: #f3f0ff; color: #6f42c1; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background-color: #ffffff;
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }
        .nav-item {
            background: none; border: none; flex-grow: 1; text-align: center;
            color: #b0b3b8; font-size: 0.7rem; font-weight: 500;
        }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .d-none { display: none !important; }
    </style>
</head>
<body>

    <div id="view-hq" class="tab-content active">
        <h2 class="mb-4">Nexus OS</h2>
        
        <div class="nexus-card">
            <h5 class="mb-3">Quick Journal</h5>
            <div class="input-group">
                <input type="text" id="journalInput" class="form-control" placeholder="Write something...">
                <button onclick="logJournal()" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="nexus-card">
            <h5 class="mb-3">Tasks</h5>
            <div id="task-list">
                <div class="text-center text-muted small py-3">Loading tasks...</div>
            </div>
        </div>
    </div>

    <div id="view-visa" class="tab-content">
        <h2 class="mb-4">Visa Queue</h2>
        <div class="nexus-card p-0" id="backlog-container">
            <div class="text-center text-muted py-5 small">Loading backlog...</div>
        </div>
    </div>

    <div id="view-world" class="tab-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Passport</h2>
            <button class="btn btn-primary btn-sm fw-bold shadow-sm" onclick="showMovieModal()">
                <i class="fa-solid fa-plus"></i> Add Entry
            </button>
        </div>
        
        <div class="d-flex mb-3 overflow-auto pb-1">
            <button class="filter-btn active" onclick="filterMap('All')">All</button>
            <button class="filter-btn" onclick="filterMap('Book')">Books</button>
            <button class="filter-btn" onclick="filterMap('Movie')">Movies</button>
            <button class="filter-btn" onclick="filterMap('Music')">Music</button>
        </div>

        <div id="world-map" class="mb-3 shadow-sm"></div>

        <div class="row g-3">
            <div class="col-6">
                <div class="nexus-card text-center py-3 mb-0">
                    <div id="stat-countries" class="stat-number">0</div>
                    <div class="stat-label">Countries</div>
                </div>
            </div>
            <div class="col-6">
                <div class="nexus-card text-center py-3 mb-0">
                    <div id="stat-items" class="stat-number">0</div>
                    <div class="stat-label">Items</div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-history" class="tab-content">
        <h2 class="mb-3">Travel Logs</h2>
        <input type="text" id="historySearch" class="form-control mb-3 shadow-sm" placeholder="Search history..." onkeyup="renderHistory()">
        <div id="history-container" class="nexus-card p-0 border-0 bg-transparent shadow-none"></div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('hq')"><i class="fa-solid fa-house"></i>HQ</button>
        <button class="nav-item" onclick="switchTab('visa')"><i class="fa-solid fa-hourglass-half"></i>Visa</button>
        <button class="nav-item" onclick="switchTab('world')"><i class="fa-solid fa-earth-americas"></i>World</button>
        <button class="nav-item" onclick="switchTab('history')"><i class="fa-solid fa-list"></i>Logs</button>
    </nav>

    <div id="movieModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
              <h5 class="modal-title fw-bold">Log Entry</h5>
              <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body pt-0">
              <label class="small text-muted fw-bold mb-1">TITLE</label>
              <input type="text" id="mTitle" class="form-control mb-3" placeholder="e.g. Inception">
              
              <div class="form-check form-switch mb-3 p-3 bg-light rounded">
                  <input class="form-check-input" type="checkbox" id="watchedCheck" onchange="toggleRatingFields()">
                  <label class="form-check-label small fw-bold" for="watchedCheck">I have finished this</label>
              </div>

              <div id="ratingFields" class="d-none">
                  <label class="small text-muted fw-bold mb-1">RATING</label>
                  <select id="mRating" class="form-select mb-3">
                      <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                      <option value="4">⭐⭐⭐⭐ Good</option>
                      <option value="3">⭐⭐⭐ Average</option>
                      <option value="2">⭐⭐ Poor</option>
                      <option value="1">⭐ Terrible</option>
                  </select>
                  
                  <label class="small text-muted fw-bold mb-1">DATE FINISHED</label>
                  <input type="date" id="mDate" class="form-control">
              </div>
            </div>
            <div class="modal-footer border-top-0">
              <button class="btn btn-primary w-100 fw-bold py-2" onclick="handleSave()">Save Entry</button>
            </div>
          </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world.js"></script>

    <script>
        // *** IMPORTANT: PASTE YOUR GAS DEPLOYMENT URL HERE ***
        const API_URL = "https://script.google.com/macros/s/AKfycbzEdsHSoG_yfkB_lMKe7RjQoCvd9d0egA1s7LXtuSz8Se6WLjIHSeNQlK0-xOO9C7yw/exec";
        
        let fullData = [];
        let mapInstance = null;
        let currentFilter = 'All';

        // NAVIGATION
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');

            if(fullData.length === 0) fetchData(); 
            else if(tabName === 'world') setTimeout(renderMap, 100); 
        }

        // DATA FETCHING & CLEANING
        function fetchData() {
            fetch(`${API_URL}?action=getPassport`)
            .then(res => res.json())
            .then(data => {
                // FORCE RATINGS TO NUMBERS
                fullData = data.map(d => ({
                    ...d,
                    Rating: (d.Rating === "" || d.Rating === undefined || d.Rating === null) ? 0 : Number(d.Rating)
                }));
                
                renderMap();
                renderHistory();
                renderBacklog();
            });
        }

        // MAP RENDERING
        function filterMap(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === type));
            renderMap();
        }

        function renderMap() {
            const activeItems = fullData.filter(d => d.Rating > 0);
            const filteredData = currentFilter === 'All' ? activeItems : activeItems.filter(d => d.Type.includes(currentFilter));

            const countryStats = {};
            filteredData.forEach(item => {
                const code = item.Country_Code;
                if(!code || code === '??') return;
                if(!countryStats[code]) countryStats[code] = 0;
                countryStats[code]++;
            });

            document.getElementById('stat-countries').innerText = Object.keys(countryStats).length;
            document.getElementById('stat-items').innerText = filteredData.length;

            document.getElementById('world-map').innerHTML = "";

            mapInstance = new jsVectorMap({
                selector: "#world-map",
                map: "world",
                zoomButtons: false,
                visualizeData: {
                    scale: ['#e4e6eb', '#0d6efd'], // Light Grey to Blue
                    values: Object.keys(countryStats).reduce((acc, code) => ({...acc, [code]: 1}), {})
                },
                regionStyle: {
                    initial: { fill: '#e4e6eb' }, // Base Color
                    hover: { fill: '#d8dadf' },
                    selected: { fill: '#0d6efd' } // Visited Color
                },
                series: {
                    regions: [{
                        scale: { 1: '#0d6efd' }, // Force Blue
                        attribute: 'fill',
                        values: Object.keys(countryStats).reduce((acc, code) => ({...acc, [code]: 1}), {})
                    }]
                }
            });
        }

        // HISTORY LIST
        function renderHistory() {
            const query = document.getElementById('historySearch').value.toLowerCase();
            const completed = fullData.filter(d => d.Rating > 0).reverse();
            const filtered = completed.filter(d => d.Title.toLowerCase().includes(query));

            const html = filtered.map(d => `
                <div class="history-item bg-white px-3 mb-2 rounded border">
                    <div>
                        <div class="item-title">${d.Title}</div>
                        <div class="item-meta">${d.Creator || "?"} • ${d.Country_Code}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge-type ${getBadgeClass(d.Type)}">${d.Type}</span>
                        <div class="text-warning small mt-1">${"★".repeat(Math.round(d.Rating))}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('history-container').innerHTML = html || '<div class="text-muted text-center py-4">No history found.</div>';
        }

        // BACKLOG (VISA)
        function renderBacklog() {
            const backlog = fullData.filter(d => d.Rating === 0);
            const html = backlog.map(d => `
                <div class="history-item bg-white px-3 mb-2 rounded border">
                    <div>
                        <div class="item-title">${d.Title}</div>
                        <div class="item-meta">${d.Creator || "Unknown"}</div>
                    </div>
                    <span class="badge bg-light text-dark border">In Queue</span>
                </div>
            `).join('');
            document.getElementById('backlog-container').innerHTML = html || '<div class="text-center text-muted py-5">Visa queue empty.</div>';
        }

        function getBadgeClass(type) {
            if(type.includes("Book")) return "bg-book";
            if(type.includes("Movie")) return "bg-movie";
            return "bg-music";
        }

        // MODAL & SAVE
        let modalInstance = null;
        function showMovieModal() {
            modalInstance = new bootstrap.Modal(document.getElementById('movieModal'));
            modalInstance.show();
            document.getElementById('mTitle').value = "";
            document.getElementById('watchedCheck').checked = false;
            document.getElementById('ratingFields').classList.add('d-none');
            document.getElementById('mDate').valueAsDate = new Date();
        }

        function toggleRatingFields() {
            const isWatched = document.getElementById('watchedCheck').checked;
            const fields = document.getElementById('ratingFields');
            if (isWatched) fields.classList.remove('d-none');
            else fields.classList.add('d-none');
        }

        function closeModal() { if(modalInstance) modalInstance.hide(); }

        function handleSave() {
            const title = document.getElementById('mTitle').value;
            const isWatched = document.getElementById('watchedCheck').checked;
            
            if(!title) { alert("Title required"); return; }
            
            const rating = isWatched ? document.getElementById('mRating').value : 0;
            const status = isWatched ? 'watched' : 'watchlist';
            const date = isWatched ? document.getElementById('mDate').value : "";

            // Optimistic UI
            fullData.push({ Title: title, Creator: "Unknown", Type: "Movie", Country_Code: "??", Rating: Number(rating) });
            renderMap(); renderHistory(); renderBacklog();
            closeModal();

            fetch(`${API_URL}?action=logMovie&title=${encodeURIComponent(title)}&rating=${rating}&status=${status}&date=${date}`);
        }

        function logJournal() {
            const text = document.getElementById('journalInput').value;
            if(!text) return;
            fetch(`${API_URL}?action=logJournal&text=${encodeURIComponent(text)}`);
            document.getElementById('journalInput').value = "";
            alert("Journal Logged");
        }

        // START
        fetchData();
    </script>
</body>
</html>
