<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus OS 3.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap/dist/css/jsvectormap.min.css" />

    <style>
        :root {
            /* REFINED PALETTE (Grey/Green Theme) */
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            
            --accent: #27ae60; /* Green for Visited/Active */
            --map-base: #2c3e50; /* Subtle Grey-Blue for Map Base */
            
            --nav-height: 65px;
            
            /* TYPE BADGE COLORS */
            --col-book: #3498db; /* Blue */
            --col-movie: #e74c3c; /* Red */
            --col-music: #f1c40f; /* Yellow */
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: var(--nav-height);
        }

        .nexus-card {
            background-color: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        /* MAP STYLING */
        #world-map {
            width: 100%;
            height: 320px;
            background-color: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* HISTORY ITEMS */
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #333;
        }
        .history-item:last-child { border-bottom: none; }
        
        .type-badge { font-size: 10px; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .type-book { color: var(--col-book); border: 1px solid var(--col-book); }
        .type-movie { color: var(--col-movie); border: 1px solid var(--col-movie); }
        .type-music { color: var(--col-music); border: 1px solid var(--col-music); }

        /* FILTER BUTTONS */
        .filter-btn {
            border: 1px solid var(--border); background: var(--bg-card); color: var(--text-muted);
            font-size: 13px; padding: 6px 14px; border-radius: 20px; margin-right: 5px;
        }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background-color: #181818; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { color: #666; font-size: 11px; background: none; border: none; flex-grow: 1; text-align: center;}
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); }

        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        
        /* HIDDEN ELEMENTS FOR TOGGLE */
        .d-none { display: none !important; }
    </style>
</head>
<body>

    <div id="view-hq" class="tab-content active">
        <h2 class="mb-4">Nexus OS</h2>
        <div class="nexus-card">
            <div class="input-group">
                <input type="text" id="journalInput" class="form-control bg-dark text-white border-secondary" placeholder="Log a thought...">
                <button onclick="logJournal()" class="btn btn-secondary"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
        <div class="nexus-card">
            <h5 class="text-white mb-3"><i class="fa-solid fa-check-circle me-2 text-success"></i>Tasks</h5>
            <div id="task-list"><div class="text-center text-muted">Loading...</div></div>
        </div>
    </div>

    <div id="view-visa" class="tab-content">
        <h2 class="mb-4">Visa in Process</h2>
        <div class="nexus-card p-0 border-0" id="backlog-container">
            <div class="text-center text-muted p-4">Loading Visa...</div>
        </div>
    </div>

    <div id="view-world" class="tab-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Passport</h2>
            <button class="btn btn-outline-success btn-sm" onclick="showMovieModal()">
                <i class="fa-solid fa-plus"></i> Add Entry
            </button>
        </div>
        
        <div class="d-flex mb-3 overflow-auto pb-1">
            <button class="filter-btn active" onclick="filterMap('All')">All</button>
            <button class="filter-btn" onclick="filterMap('Book')">Books</button>
            <button class="filter-btn" onclick="filterMap('Movie')">Movies</button>
            <button class="filter-btn" onclick="filterMap('Music')">Music</button>
        </div>

        <div id="world-map" class="mb-3"></div>

        <div class="row g-2">
            <div class="col-6">
                <div class="nexus-card text-center p-2">
                    <h3 id="stat-countries" class="text-white mb-0">0</h3>
                    <small class="text-muted" style="font-size: 11px">Countries</small>
                </div>
            </div>
            <div class="col-6">
                <div class="nexus-card text-center p-2">
                    <h3 id="stat-items" class="text-white mb-0">0</h3>
                    <small class="text-muted" style="font-size: 11px">Items</small>
                </div>
            </div>
        </div>
    </div>

    <div id="view-history" class="tab-content">
        <h2 class="mb-3">Travel Logs</h2>
        <input type="text" id="historySearch" class="form-control bg-dark text-white border-secondary mb-3" placeholder="Search..." onkeyup="renderHistory()">
        <div id="history-container"></div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('hq')"><i class="fa-solid fa-house"></i>HQ</button>
        <button class="nav-item" onclick="switchTab('visa')"><i class="fa-solid fa-hourglass-half"></i>Visa</button>
        <button class="nav-item" onclick="switchTab('world')"><i class="fa-solid fa-earth-americas"></i>World</button>
        <button class="nav-item" onclick="switchTab('history')"><i class="fa-solid fa-list"></i>Logs</button>
    </nav>

    <div id="movieModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
              <h5 class="text-white">Log Entry</h5>
              <button type="button" class="btn-close btn-close-white" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
              <input type="text" id="mTitle" class="form-control bg-black text-white mb-3 border-secondary" placeholder="Title (e.g. Inception)">
              
              <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="watchedCheck" onchange="toggleRatingFields()">
                  <label class="form-check-label text-white" for="watchedCheck">I have already watched/read this</label>
              </div>

              <div id="ratingFields" class="d-none">
                  <select id="mRating" class="form-control bg-black text-white mb-2 border-secondary">
                      <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                      <option value="4">⭐⭐⭐⭐ (4)</option>
                      <option value="3">⭐⭐⭐ (3)</option>
                      <option value="2">⭐⭐ (2)</option>
                      <option value="1">⭐ (1)</option>
                  </select>
                  <input type="date" id="mDate" class="form-control bg-black text-white border-secondary">
              </div>
            </div>
            <div class="modal-footer border-secondary">
              <button class="btn btn-success w-100" onclick="handleSave()">Save Entry</button>
            </div>
          </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world.js"></script>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzEdsHSoG_yfkB_lMKe7RjQoCvd9d0egA1s7LXtuSz8Se6WLjIHSeNQlK0-xOO9C7yw/exec";
        
        let fullData = [];
        let mapInstance = null;
        let currentFilter = 'All';

        // --- NAVIGATION ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');

            if(fullData.length === 0) fetchData(); 
            else if(tabName === 'world') setTimeout(renderMap, 100); 
        }

        // --- DATA ENGINE ---
        function fetchData() {
            fetch(`${API_URL}?action=getPassport`)
            .then(res => res.json())
            .then(data => {
                // CLEAN DATA: Ensure Ratings are Numbers
                fullData = data.map(d => ({
                    ...d,
                    Rating: (d.Rating === "" || d.Rating === undefined) ? 0 : Number(d.Rating)
                }));
                
                renderMap();
                renderHistory();
                renderBacklog();
            });
        }

        // --- MAP LOGIC (Green/Grey) ---
        function filterMap(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.innerText === type));
            renderMap();
        }

        function renderMap() {
            // Filter: Only Completed Items (Rating > 0)
            const activeItems = fullData.filter(d => d.Rating > 0);
            const filteredData = currentFilter === 'All' ? activeItems : activeItems.filter(d => d.Type.includes(currentFilter));

            // Aggregate Data
            const countryStats = {};
            filteredData.forEach(item => {
                const code = item.Country_Code;
                if(!code || code === '??') return;
                if(!countryStats[code]) countryStats[code] = 0;
                countryStats[code]++;
            });

            document.getElementById('stat-countries').innerText = Object.keys(countryStats).length;
            document.getElementById('stat-items').innerText = filteredData.length;

            document.getElementById('world-map').innerHTML = "";

            mapInstance = new jsVectorMap({
                selector: "#world-map",
                map: "world",
                zoomButtons: false,
                visualizeData: {
                    scale: ['#2c3e50', '#27ae60'], // Grey to Green
                    values: Object.keys(countryStats).reduce((acc, code) => ({...acc, [code]: 1}), {})
                },
                regionStyle: {
                    initial: { fill: '#343a40' }, // Dark Grey base
                    hover: { fill: '#495057' },
                    selected: { fill: '#27ae60' } // Green
                },
                series: {
                    regions: [{
                        scale: { 1: '#27ae60' }, // Force Green
                        attribute: 'fill',
                        values: Object.keys(countryStats).reduce((acc, code) => ({...acc, [code]: 1}), {})
                    }]
                }
            });
        }

        // --- HISTORY (Logs) ---
        function renderHistory() {
            const query = document.getElementById('historySearch').value.toLowerCase();
            const completed = fullData.filter(d => d.Rating > 0).reverse(); // Rating > 0 means done
            const filtered = completed.filter(d => d.Title.toLowerCase().includes(query));

            const html = filtered.map(d => `
                <div class="history-item">
                    <div>
                        <div class="fw-bold text-white">${d.Title}</div>
                        <div class="small text-muted">${d.Creator || "?"} • ${d.Country_Code}</div>
                    </div>
                    <div class="text-end">
                        <span class="type-badge ${getTypeClass(d.Type)}">${d.Type}</span>
                        <div class="text-warning small mt-1">${"★".repeat(Math.round(d.Rating))}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('history-container').innerHTML = html || '<div class="text-muted text-center mt-3">No history found.</div>';
        }

        // --- BACKLOG (Visa) ---
        function renderBacklog() {
            // Rating 0 means backlog
            const backlog = fullData.filter(d => d.Rating === 0);
            
            const html = backlog.map(d => `
                <div class="history-item">
                    <div>
                        <div class="fw-bold text-white">${d.Title}</div>
                        <div class="small text-muted">${d.Creator || "Unknown"}</div>
                    </div>
                    <span class="badge bg-secondary">In Queue</span>
                </div>
            `).join('');
            document.getElementById('backlog-container').innerHTML = html || '<div class="text-muted text-center mt-5">Visa queue empty.</div>';
        }

        function getTypeClass(type) {
            if(type.includes("Book")) return "type-book";
            if(type.includes("Movie")) return "type-movie";
            return "type-music";
        }

        // --- NEW MODAL LOGIC ---
        let modalInstance = null;
        function showMovieModal() {
            modalInstance = new bootstrap.Modal(document.getElementById('movieModal'));
            modalInstance.show();
            // Reset fields
            document.getElementById('mTitle').value = "";
            document.getElementById('watchedCheck').checked = false;
            document.getElementById('ratingFields').classList.add('d-none');
            document.getElementById('mDate').valueAsDate = new Date();
        }

        function toggleRatingFields() {
            const isWatched = document.getElementById('watchedCheck').checked;
            const fields = document.getElementById('ratingFields');
            if (isWatched) fields.classList.remove('d-none');
            else fields.classList.add('d-none');
        }

        function closeModal() { if(modalInstance) modalInstance.hide(); }

        function handleSave() {
            const title = document.getElementById('mTitle').value;
            const isWatched = document.getElementById('watchedCheck').checked;
            
            if(!title) { alert("Title required"); return; }
            
            // If Watched: Rating is user value. If Watchlist: Rating is 0.
            const rating = isWatched ? document.getElementById('mRating').value : 0;
            const status = isWatched ? 'watched' : 'watchlist';
            const date = isWatched ? document.getElementById('mDate').value : "";

            // Optimistic UI
            fullData.push({ Title: title, Creator: "Unknown", Type: "Movie", Country_Code: "??", Rating: Number(rating) });
            renderMap(); renderHistory(); renderBacklog();
            closeModal();

            // API Call
            fetch(`${API_URL}?action=logMovie&title=${encodeURIComponent(title)}&rating=${rating}&status=${status}&date=${date}`)
            .then(res => res.json());
        }

        function logJournal() {
            const text = document.getElementById('journalInput').value;
            if(!text) return;
            fetch(`${API_URL}?action=logJournal&text=${encodeURIComponent(text)}`);
            document.getElementById('journalInput').value = "";
            alert("Journal Logged");
        }

        // INIT
        fetchData();
    </script>
</body>
</html>
